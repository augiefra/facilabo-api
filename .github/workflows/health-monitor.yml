name: FacilAbo Health Monitor

on:
  schedule:
    # Check every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # Allow manual trigger

concurrency:
  group: facilabo-health-monitor
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check API Health (2 consecutive samples)
        id: health
        run: |
          set +e
          set +o pipefail

          fetch_health () {
            local response http_code body overall message critical_down down
            response=$(curl -sS --connect-timeout 5 --max-time 15 -w "\n%{http_code}" https://facilabo-api.vercel.app/api/v1/health/status || printf "\n000")
            http_code=$(echo "$response" | tail -n 1)
            body=$(echo "$response" | sed '$d')
            overall=$(echo "$body" | jq -r '.overall // "unknown"' 2>/dev/null || echo "unknown")
            message=$(echo "$body" | jq -r '.uptimeMessage // "No message"' 2>/dev/null || echo "No message")
            critical_down=$(echo "$body" | jq -r '.summary.criticalDown // 0' 2>/dev/null || echo "0")
            down=$(echo "$body" | jq -r '.summary.down // 0' 2>/dev/null || echo "0")
            echo "${http_code}|${overall}|${message}|${critical_down}|${down}"
          }

          is_alert_condition () {
            local http_code="$1"
            local overall="$2"
            if [ "$http_code" != "200" ]; then
              return 0
            fi
            if [ "$overall" = "unhealthy" ]; then
              return 0
            fi
            return 1
          }

          sample1=$(fetch_health)
          IFS='|' read -r HTTP_CODE OVERALL MESSAGE CRITICAL_DOWN DOWN <<< "$sample1"

          SHOULD_ALERT="false"
          ALERT_REASON="single-sample-healthy"

          if is_alert_condition "$HTTP_CODE" "$OVERALL"; then
            echo "First sample unhealthy. Running confirmation sample in 20s..."
            sleep 20
            sample2=$(fetch_health)
            IFS='|' read -r HTTP_CODE_2 OVERALL_2 MESSAGE_2 CRITICAL_DOWN_2 DOWN_2 <<< "$sample2"

            if is_alert_condition "$HTTP_CODE_2" "$OVERALL_2"; then
              SHOULD_ALERT="true"
              ALERT_REASON="confirmed-2-consecutive-unhealthy-samples"
              HTTP_CODE="$HTTP_CODE_2"
              OVERALL="$OVERALL_2"
              MESSAGE="$MESSAGE_2"
              CRITICAL_DOWN="$CRITICAL_DOWN_2"
              DOWN="$DOWN_2"
            else
              ALERT_REASON="transient-failure-first-sample-only"
            fi
          fi

          echo "overall=$OVERALL" >> "$GITHUB_OUTPUT"
          echo "message=$MESSAGE" >> "$GITHUB_OUTPUT"
          echo "http_code=$HTTP_CODE" >> "$GITHUB_OUTPUT"
          echo "critical_down=$CRITICAL_DOWN" >> "$GITHUB_OUTPUT"
          echo "down=$DOWN" >> "$GITHUB_OUTPUT"
          echo "should_alert=$SHOULD_ALERT" >> "$GITHUB_OUTPUT"
          echo "alert_reason=$ALERT_REASON" >> "$GITHUB_OUTPUT"

          if [ "$SHOULD_ALERT" = "true" ]; then
            echo "::warning::API unhealthy confirmed: HTTP $HTTP_CODE - $MESSAGE (down=$DOWN, criticalDown=$CRITICAL_DOWN)"
          else
            echo "‚úÖ API healthy/noise filtered: $MESSAGE (down=$DOWN, criticalDown=$CRITICAL_DOWN, reason=$ALERT_REASON)"
          fi

          # Never fail the workflow (no "run failed" emails).
          exit 0

      - name: Create Issue on Failure
        if: steps.health.outputs.should_alert == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const overall = '${{ steps.health.outputs.overall }}';
              const message = '${{ steps.health.outputs.message }}';
              const httpCode = '${{ steps.health.outputs.http_code }}';
              const criticalDown = '${{ steps.health.outputs.critical_down }}';
              const down = '${{ steps.health.outputs.down }}';
              const alertReason = '${{ steps.health.outputs.alert_reason }}';
              const timestamp = new Date().toISOString();

              // Check if there's already an open issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'health-alert'
              });

              // Don't create duplicate issues
              if (issues.data.length > 0) {
                console.log('Alert issue already exists, skipping creation');

                // Add a comment to the existing issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues.data[0].number,
                  body: `‚ö†Ô∏è **Health check still failing**\n\n- Time: ${timestamp}\n- HTTP Code: ${httpCode}\n- Status: ${overall}\n- Message: ${message}\n- Sources down: ${down}\n- Critical sources down: ${criticalDown}\n- Confirmation: ${alertReason}`
                });
                return;
              }

              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® API Health Alert - ${message}`,
                labels: ['health-alert', 'bug'],
                body: `## FacilAbo API Health Alert

            L'API est actuellement **${overall}**.

            ### D√©tails

            | M√©trique | Valeur |
            |----------|--------|
            | Statut HTTP | ${httpCode} |
            | √âtat global | ${overall} |
            | Sources down | ${down} |
            | Sources critiques down | ${criticalDown} |
            | Message | ${message} |
            | Confirmation | ${alertReason} |
            | Timestamp | ${timestamp} |

            ### Actions

            1. V√©rifier l'endpoint: https://facilabo-api.vercel.app/api/v1/health/status
            2. Consulter les logs Vercel
            3. Fermer cette issue une fois le probl√®me r√©solu

            ---
            *G√©n√©r√© automatiquement par GitHub Actions*`
              });
            } catch (error) {
              console.log('Issue creation failed (ignored):', error);
            }

      - name: Send Email Alert
        if: steps.health.outputs.should_alert == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.ALERT_SMTP_HOST }}
          server_port: ${{ secrets.ALERT_SMTP_PORT }}
          secure: true
          username: ${{ secrets.ALERT_SMTP_USER }}
          password: ${{ secrets.ALERT_SMTP_PASS }}
          from: ${{ secrets.ALERT_EMAIL_FROM }}
          to: ${{ secrets.ALERT_EMAIL_TO }}
          subject: "[FacilAbo] Health alert - ${{ steps.health.outputs.message }}"
          body: |
            Health alert confirmed (2 consecutive samples).
            HTTP: ${{ steps.health.outputs.http_code }}
            Overall: ${{ steps.health.outputs.overall }}
            Message: ${{ steps.health.outputs.message }}
            Down: ${{ steps.health.outputs.down }}
            Critical down: ${{ steps.health.outputs.critical_down }}
            Timestamp: ${{ github.run_id }}

      - name: Close Resolved Issues
        id: close_issues
        if: steps.health.outputs.should_alert != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            // Find open health-alert issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-alert'
            });
            core.setOutput('had_open_issue', issues.data.length > 0 ? 'true' : 'false');

            // Close them since health is restored
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ **R√©solu** - L'API est de nouveau en bonne sant√©.\n\nFermeture automatique de cette alerte.`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              console.log(`Closed issue #${issue.number}`);
            }

      - name: Send Email Resolved
        if: steps.health.outputs.should_alert != 'true' && steps.close_issues.outputs.had_open_issue == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.ALERT_SMTP_HOST }}
          server_port: ${{ secrets.ALERT_SMTP_PORT }}
          secure: true
          username: ${{ secrets.ALERT_SMTP_USER }}
          password: ${{ secrets.ALERT_SMTP_PASS }}
          from: ${{ secrets.ALERT_EMAIL_FROM }}
          to: ${{ secrets.ALERT_EMAIL_TO }}
          subject: "[FacilAbo] Health resolved"
          body: |
            L'API est de nouveau en bonne sant√©.
            Message: ${{ steps.health.outputs.message }}
            Timestamp: ${{ github.run_id }}
