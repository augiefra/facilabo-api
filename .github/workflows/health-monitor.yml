name: FacilAbo Health Monitor

on:
  schedule:
    # Check every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check API Health
        id: health
        run: |
          RESPONSE=$(curl -sS --connect-timeout 5 --max-time 15 -w "\n%{http_code}" https://facilabo-api.vercel.app/api/v1/health/status)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          # Extract key info
          OVERALL=$(echo "$BODY" | jq -r '.overall // "unknown"')
          MESSAGE=$(echo "$BODY" | jq -r '.uptimeMessage // "No message"')
          CRITICAL_DOWN=$(echo "$BODY" | jq -r '.summary.criticalDown // 0')

          echo "overall=$OVERALL" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "critical_down=$CRITICAL_DOWN" >> $GITHUB_OUTPUT

          # Fail if unhealthy (503) or if request failed
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::API is unhealthy! HTTP $HTTP_CODE - $MESSAGE"
            exit 1
          fi

          echo "‚úÖ API is healthy: $MESSAGE"

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const overall = '${{ steps.health.outputs.overall }}';
            const message = '${{ steps.health.outputs.message }}';
            const httpCode = '${{ steps.health.outputs.http_code }}';
            const criticalDown = '${{ steps.health.outputs.critical_down }}';
            const timestamp = new Date().toISOString();

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-alert'
            });

            // Don't create duplicate issues
            if (issues.data.length > 0) {
              console.log('Alert issue already exists, skipping creation');

              // Add a comment to the existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `‚ö†Ô∏è **Health check still failing**\n\n- Time: ${timestamp}\n- HTTP Code: ${httpCode}\n- Status: ${overall}\n- Message: ${message}\n- Critical sources down: ${criticalDown}`
              });
              return;
            }

            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® API Health Alert - ${message}`,
              labels: ['health-alert', 'bug'],
              body: `## FacilAbo API Health Alert

            L'API est actuellement **${overall}**.

            ### D√©tails

            | M√©trique | Valeur |
            |----------|--------|
            | Statut HTTP | ${httpCode} |
            | √âtat global | ${overall} |
            | Sources critiques down | ${criticalDown} |
            | Message | ${message} |
            | Timestamp | ${timestamp} |

            ### Actions

            1. V√©rifier l'endpoint: https://facilabo-api.vercel.app/api/v1/health/status
            2. Consulter les logs Vercel
            3. Fermer cette issue une fois le probl√®me r√©solu

            ---
            *G√©n√©r√© automatiquement par GitHub Actions*`
            });

      - name: Close Resolved Issues
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // Find open health-alert issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-alert'
            });

            // Close them since health is restored
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ **R√©solu** - L'API est de nouveau en bonne sant√©.\n\nFermeture automatique de cette alerte.`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              console.log(`Closed issue #${issue.number}`);
            }
